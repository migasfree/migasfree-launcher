#!/usr/bin/python
# -*- coding: utf-8 -*-

# Copyright (c) 2014 Alberto Gacías, Jose Antonio Chavarría
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.
#
# Author: Alberto Gacías <alberto@migasfree.org>
# Author: Jose Antonio Chavarría <jachavar@gmail.com>

__author__ = ['Alberto Gacías', 'Jose Antonio Chavarría']
__license__ = 'GPLv3'
__version__ = '1.3'

import os
import sys
import threading
import locale
import subprocess
import webbrowser
import optparse

import gettext
_ = gettext.gettext

from gi.repository import (
    Gio,
    GObject,
    Gtk,
    Gdk,
    AppIndicator3 as AppIndicator,
)


class Console(Gtk.Window):
    def __init__(self):
        super(Console, self).__init__()

        sw = Gtk.ScrolledWindow()
        sw.set_policy(Gtk.PolicyType.AUTOMATIC, Gtk.PolicyType.AUTOMATIC)
        self.textview = Gtk.TextView()
        self.textbuffer = self.textview.get_buffer()
        self.textview.set_editable(False)
        sw.add(self.textview)

        self.set_title(_('Consola migasfree'))
        self.set_icon_name('migasfree')
        self.resize(600, 400)
        self.set_property('deletable', False)
        self.set_decorated(True)
        self.set_border_width(10)

        button = Gtk.Button(_('Ocultar'))
        button.connect("clicked", self.on_click_hide, None)

        vbox = Gtk.VBox(spacing=6)
        vbox.pack_start(sw, expand=True, fill=True, padding=0)

        self.progress = Gtk.ProgressBar()
        vboxprogress = Gtk.VBox(False, 0)
        vboxprogress.pack_start(self.progress, False, True, 0)
        self.progress.set_pulse_step(0.02)
        vbox.pack_start(vboxprogress, False, True, 0)

        vbox.pack_start(button, False, True, 0)
        self.add(vbox)

    def on_timeout(self, user_data):
        self.progress.pulse()
        return True

    def on_click_hide(self, widget, data=None):
        self.hide()


class SystrayIconApp(object):
    SCHEMA = "org.migasfree.console"
    SHOW_CONSOLE = "show-console"

    CMD_UPGRADE = "sudo migasfree-launcher"
    CMD_FORCE_UPGRADE = "sudo migasfree --update --force-upgrade"
    CMD_LABEL = "migasfree-label"
    CMD_APPS = "migasfree-apps"

    FIRST_RUN = "/var/tmp/migasfree/first-tags.conf"

    def __init__(self, options):
        if options.interval:
            self.interval = options.interval * 3600000
        else:
            self.interval = 24 * 3600000

        if options.support:
            self.support = options.support
        else:
            self.support = ''

        self.is_force_upgrade = (options.force_upgrade == True)

        self.console = Console()
        if os.path.isfile(self.FIRST_RUN):
            self.console.show_all()

        self.is_upgrading = False

        self.icon = self.choose_icon()

        self.tray = AppIndicator.Indicator.new(
            'migasfree-tray',
            self.icon,
            AppIndicator.IndicatorCategory.APPLICATION_STATUS
        )
        self.tray.set_status(AppIndicator.IndicatorStatus.ACTIVE)
        self.tray.set_attention_icon('attention_icon')
        self.tray.set_icon(self.icon)

        self.mode_console = self.get_console()
        self.make_menu()

        self.update_system()
        GObject.timeout_add(self.interval, self.update_system)

    def choose_icon(self):
        _icon = 'migasfree-idle-dark'

        _settings = Gtk.Settings.get_default()
        if _settings.get_property('gtk-theme-name') == 'Radiance':
            _icon = 'migasfree-idle-light'

        return _icon

    def make_menu(self):
        self.menu = Gtk.Menu()

        # TODO
        '''
        _apps = Gtk.ImageMenuItem(_('Aplicaciones'))
        _apps.set_image(self.get_image("migasfree-apps"))
        _apps.set_sensitive(False)
        _apps.show()
        _apps.connect('activate', self.show_apps)
        self.menu.append(_apps)

        self.menu.append(Gtk.SeparatorMenuItem())
        '''

        self.menu_force_upgrade = Gtk.ImageMenuItem(_('Forzar actualización'))
        self.menu_force_upgrade.set_image(
            self.get_image("migasfree-force-upgrade")
        )
        self.menu_force_upgrade.set_sensitive(not self.is_upgrading)
        self.menu_force_upgrade.show()
        self.menu_force_upgrade.connect('activate', self.force_upgrade)
        self.menu.append(self.menu_force_upgrade)

        self.menu.append(Gtk.SeparatorMenuItem())

        _menu_console= Gtk.ImageMenuItem(_('Consola'))
        _menu_console.set_image(self.get_image("migasfree-console"))
        _menu_console.show()
        _menu_console.connect('activate',self.show_console)
        self.menu.append(_menu_console)

        _menu_mode_console = Gtk.CheckMenuItem(_('Mostrar consola siempre'))
        _menu_mode_console.connect('activate', self.on_show_console)
        _menu_mode_console.set_active(self.mode_console)
        self.menu.append(_menu_mode_console)

        self.menu.append(Gtk.SeparatorMenuItem())

        _label_id = Gtk.ImageMenuItem(_('Etiqueta de identificación'))
        _label_id.set_image(self.get_image("migasfree-label"))
        _label_id.show()
        _label_id.connect('activate', self.show_label_id)
        self.menu.append(_label_id)

        if self.support:
            _support = Gtk.ImageMenuItem(_('Soporte'))
            _support.set_image(self.get_image("migasfree-support"))
            _support.show()
            _support.connect('activate', self.show_support)
            self.menu.append(_support)

        self.menu.append(Gtk.SeparatorMenuItem())

        _about = Gtk.MenuItem(_('Acerca de'))
        _about.show()
        _about.connect('activate', self.show_about)
        self.menu.append(_about)

        self.menu.show_all()
        self.tray.set_menu(self.menu)

    def set_console(self, value):
        _settings = Gio.Settings.new(self.SCHEMA)
        _settings.set_boolean(self.SHOW_CONSOLE, value)

    def get_console(self):
        _settings = Gio.Settings.new(self.SCHEMA)

        return _settings.get_boolean(self.SHOW_CONSOLE)

    def on_show_console(self, widget):
        self.set_console(widget.get_active())
        self.mode_console = widget.get_active()

    def get_image(self, name):
        _img = Gtk.Image()
        _img.set_from_icon_name(name, Gtk.IconSize.MENU)

        return _img

    def show_console(self, widget):
        if self.console.get_property("visible"):
            self.console.hide()
        else:
            self.console.show_all()

    def show_label_id(self, widget):
        os.system(self.CMD_LABEL)

    def show_apps(self, widget):
        os.system(self.CMD_APPS)

    def show_support(self, widget):
        webbrowser.open(self.support)

    def show_about(self, widget):
        _about_dialog = Gtk.AboutDialog()

        _about_dialog.set_destroy_with_parent(True)
        _about_dialog.set_icon_name("migasfree")
        _about_dialog.set_logo_icon_name('migasfree')
        _about_dialog.set_name(__file__)
        _about_dialog.set_version(__version__)
        _about_dialog.set_copyright("(C) 2010-2014 migasfree team")
        _about_dialog.set_comments(_("Migasfree Systray"))
        _about_dialog.set_authors(['Alberto Gacías', 'Jose Antonio Chavarría'])
        _about_dialog.set_website("http://migasfree.org/")
        _about_dialog.set_website_label("migasfree.org")

        _about_dialog.run()
        _about_dialog.destroy()

    def upgrade(self, widget):
        self.run(self.CMD_UPGRADE)

    def force_upgrade(self, widget):
        self.run(self.CMD_FORCE_UPGRADE)

    def update_system(self):
        if not self.is_upgrading:
            if self.is_force_upgrade:
                self.force_upgrade(None)
            else:
                self.upgrade(None)

        return True

    def show_tags(self, widget):
        self.run(self.CMD_TAGS)

    def run(self, command):
        if self.mode_console:
            self.console.show_all()

        thread = threading.Thread(
            target=self.read_output,
            args=(self.console, command)
        )
        self.console.textbuffer.set_text("")
        thread.start()

    def read_output(self, console, command):
        self.is_upgrading = True

        self.menu_force_upgrade.set_sensitive(False)
        self.console.timeout_id = GObject.timeout_add(
            50,
            self.console.on_timeout,
            None
        )

        self.tray.set_icon('migasfree')

        _process = subprocess.Popen(
            command.split(" "),
            stdout=subprocess.PIPE,
            stderr=subprocess.STDOUT
        )

        while _process.returncode == None:
            try:
                _line = _process.stdout.readline()
            except:
                pass

            if not _line and _process.poll() != None:
                break

            _line = _line.replace("\033[92m", "")
            _line = _line.replace("\033[91m", "")
            _line = _line.replace("\033[32m", "")
            _line = _line.replace("\033[0m", "")

            GObject.idle_add(self.add_text_to_console, console, _line)

        self.tray.set_icon(self.icon)
        self.is_upgrading = False
        self.menu_force_upgrade.set_sensitive(True)
        self.console.progress.set_fraction(0)
        GObject.source_remove(self.console.timeout_id)

    def add_text_to_console(self, console, line):
        _encoding = locale.getpreferredencoding()
        _utf8conv = lambda x : unicode(x, _encoding).encode('utf8')

        _iterator = console.textbuffer.get_end_iter()
        console.textbuffer.place_cursor(_iterator)
        console.textbuffer.insert(_iterator, _utf8conv(line))
        console.textview.scroll_to_mark(
            console.textbuffer.get_insert(),
            0.1, False, 0, 0
        )

if __name__ == "__main__":
    parser = optparse.OptionParser(
        description=__file__,
        prog=__file__,
        version=__version__,
        usage='%prog options'
    )

    parser.add_option(
        "--force-upgrade",
        "-a",
        action="store_true",
        help=_('Force Upgrade'),
        default=False
    )
    parser.add_option(
        "--interval",
        "-i",
        type="int",
        default=24  # hours
    )
    parser.add_option(
        "--support",
        "-s",
        action="store",
        default=""
    )

    options, arguments = parser.parse_args()

    # Show update-notifier notifications
    if os.path.isfile('/usr/bin/update-notifier'):
        settings = Gio.Settings.new('com.ubuntu.update-notifier')
        settings.set_boolean('auto-launch', False)

    GObject.threads_init()
    sia = SystrayIconApp(options)
    Gtk.main()
